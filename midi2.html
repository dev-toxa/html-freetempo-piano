<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smooth MIDI Piano Roll</title>
    <script src="https://cdn.jsdelivr.net/npm/tone@14.8.16"></script>
    <script src="https://unpkg.com/@tonejs/midi"></script>
    <style>
        body {
            background-color: #000;
            color: #fff;
            margin: 0;
            overflow: hidden;
            font-family: sans-serif;
        }

        /* 현재 연주 지점을 나타내는 고정 선 */
        #playhead {
            position: absolute;
            left: 100px;
            /* 시작 지점 여유 */
            top: 0;
            width: 2px;
            height: 100%;
            background: #ff0055;
            box-shadow: 0 0 10px #ff0055;
            z-index: 10;
        }

        #track-container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }

        #track {
            position: absolute;
            left: 100px;
            /* playhead와 동일하게 시작 */
            top: 0;
            height: 100%;
            will-change: transform;
            /* 브라우저 최적화 */
        }

        .midi-note {
            position: absolute;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 3px;
            box-sizing: border-box;
            display: flex;
            align-items: center;
            padding-left: 5px;
            font-size: 9px;
            font-weight: bold;
        }

        .white-note {
            background: linear-gradient(90deg, #e0e0e0, #ffffff);
            color: #000;
        }

        .black-note {
            background: linear-gradient(90deg, #333, #555);
            color: #fff;
        }

        #controls {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 100;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border: 1px solid #444;
        }

        button {
            cursor: pointer;
            padding: 5px 15px;
        }
    </style>
</head>

<body>

    <div id="controls">
        <input type="file" id="midi-upload" accept=".mid,.midi">
        <button id="start-btn" disabled>Loading Samples...</button>
        <div id="status" style="margin-top:5px; font-size:12px;">Wait for sampler...</div>
    </div>

    <div id="playhead"></div>
    <div id="track-container">
        <div id="track"></div>
    </div>

    <script>
        const PIXELS_PER_SECOND = 150; // 이동 속도 (숫자가 클수록 빠름)
        const NOTE_HEIGHT = 12;
        let isPlaying = false;

        const sampler = new Tone.Sampler({
            urls: {
                "C1": "c1.mp3",
                "C#1": "cs1.mp3",
                "D1": "d1.mp3",
                "D#1": "ds1.mp3",
                "E1": "e1.mp3",
                "F1": "e1.mp3",
                "F#1": "fs1.mp3",
                "G1": "g1.mp3",
                "G#1": "gs1.mp3",
                "A1": "a1.mp3",
                "A#1": "as1.mp3",
                "B1": "b1.mp3",
                "C2": "c2.mp3",
                "C#2": "cs2.mp3",
                "D2": "d2.mp3",
                "D#2": "ds2.mp3",
                "E2": "e2.mp3",
                "F2": "f2.mp3",
                "F#2": "fs2.mp3",
                "G2": "g2.mp3",
                "G#2": "gs2.mp3",
                "A2": "a2.mp3",
                "A#2": "as2.mp3",
                "B2": "b2.mp3",
                "C3": "c3.mp3",
                "C#3": "cs3.mp3",
                "D3": "d3.mp3",
                "D#3": "ds3.mp3",
                "E3": "e3.mp3",
                "F3": "f3.mp3",
                "F#3": "fs3.mp3",
                "G3": "g3.mp3",
                "G#3": "gs3.mp3",
                "A3": "a3.mp3",
                "A#3": "as3.mp3",
                "B3": "b3.mp3",
                "C4": "c4.mp3",
                "C#4": "cs4.mp3",
                "D4": "d4.mp3",
                "D#4": "ds4.mp3",
                "E4": "e4.mp3",
                "F4": "f4.mp3",
                "F#4": "fs4.mp3",
                "G4": "g4.mp3",
                "G#4": "gs4.mp3",
                "A4": "a4.mp3",
                "A#4": "as4.mp3",
                "B4": "b4.mp3",
                "C5": "c5.mp3",
                "C#5": "cs5.mp3",
                "D5": "d5.mp3",
                "D#5": "ds5.mp3",
                "E5": "e5.mp3",
                "F5": "f5.mp3",
                "F#5": "fs5.mp3",
                "G5": "g5.mp3",
                "G#5": "gs5.mp3",
                "A5": "a5.mp3",
                "A#5": "as5.mp3",
                "B5": "b5.mp3",
                "C6": "c6.mp3",
                "C#6": "cs6.mp3"
            },
            baseUrl: "./sound/Emotional/",
            attack: 0.01,
            release: 1.5,
            onload: () => {
                document.getElementById('start-btn').disabled = false;
                document.getElementById('status').innerText = "Ready to Play";
            }

        }).toDestination();

        // 2. 애니메이션 루프 (끊김 없이 부드럽게 움직이는 핵심)
        function updateAnimation() {
            if (isPlaying) {
                const currentTime = Tone.Transport.seconds;
                const offset = currentTime * PIXELS_PER_SECOND;
                // transform을 사용해야 CPU 부하가 적고 부드럽습니다.
                document.getElementById('track').style.transform = `translateX(-${offset}px)`;
            }
            requestAnimationFrame(updateAnimation);
        }
        requestAnimationFrame(updateAnimation);

        document.getElementById('midi-upload').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const arrayBuffer = await file.arrayBuffer();
            const midi = new Midi(arrayBuffer);
            renderMidi(midi);
            setupPlayback(midi);
        });

        function renderMidi(midi) {
            const track = document.getElementById('track');
            track.innerHTML = "";
            track.style.transform = `translateX(0px)`;

            midi.tracks.forEach(t => {
                t.notes.forEach(note => {
                    const div = document.createElement('div');
                    div.className = `midi-note ${note.name.includes('#') ? 'black-note' : 'white-note'}`;
                    div.style.left = `${note.time * PIXELS_PER_SECOND}px`;
                    div.style.width = `${note.duration * PIXELS_PER_SECOND}px`;
                    div.style.top = `${window.innerHeight / 2 - (note.midi - 60) * NOTE_HEIGHT}px`;
                    div.style.height = `${NOTE_HEIGHT}px`;
                    div.innerText = note.name;
                    track.appendChild(div);
                });
            });
        }

        function setupPlayback(midi) {
            const startBtn = document.getElementById('start-btn');
            startBtn.onclick = async () => {
                await Tone.start();

                // 초기화
                Tone.Transport.stop();
                Tone.Transport.cancel();
                Tone.Transport.seconds = 0;

                midi.tracks.forEach(track => {
                    new Tone.Part((time, note) => {
                        sampler.triggerAttackRelease(note.name, note.duration, time, note.velocity);
                    }, track.notes).start(0);
                });

                Tone.Transport.start();
                isPlaying = true;
                document.getElementById('status').innerText = "Playing...";
            };
        }
    </script>
</body>

</html>